version: 2

models:
  - name: mart_benchmarks
    description: "Cohort benchmarks by industry, employee band, and region."
    columns:
      - name: industry
        tests:
          - not_null
      - name: employee_band
        tests:
          - not_null
      - name: region
        tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [industry, employee_band, region]

  - name: mart_app_overview
    description: "App-level KPIs with utilization, spend, and rightsizing signals."
    columns:
      - name: org_id
        tests:
          - not_null
      - name: app_id
        tests:
          - not_null
      - name: utilization_rate
        description: "Active seats divided by assigned seats."
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"
      - name: assigned_seats
        description: "Distinct users assigned to the app."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: active_seats
        description: "Assigned users with recent activity (see active_user_days)."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: inactive_seats
        description: "Assigned users without recent activity."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: total_spend_12m
        description: "Trailing 12-month spend per app."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: avg_monthly_spend_12m
        description: "Trailing 12-month spend divided by 12."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: cost_per_active_seat
        description: "Total spend (12m) divided by active seats."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: rightsizing_opportunity
        description: "Max(assigned seats - active seats, 0) * price per seat."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: over_licensed_flag
        description: "True when utilization is below cohort P25."
        tests:
          - accepted_values:
              values: [true, false]
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [org_id, app_id]

  - name: mart_user_reclaim_candidates
    description: "Inactive user assignments with estimated reclaim savings."
    columns:
      - name: org_id
        tests:
          - not_null
      - name: app_id
        tests:
          - not_null
      - name: user_id
        tests:
          - not_null
      - name: recommendation_action
        tests:
          - accepted_values:
              values: ["reclaim_seat"]
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [org_id, app_id, user_id]

  - name: mart_spend_vs_usage
    description: "Monthly spend and usage trends with efficiency scoring."
    columns:
      - name: org_id
        tests:
          - not_null
      - name: app_id
        tests:
          - not_null
      - name: month
        tests:
          - not_null
      - name: total_amount
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: active_users
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: utilization_rate_month
        tests:
          - dbt_utils.expression_is_true:
              expression: "between 0 and 1"
      - name: cost_per_active_seat_month
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [org_id, app_id, month]

  - name: mart_recommendations
    description: "Actionable recommendations with evidence and expected savings."
    columns:
      - name: org_id
        tests:
          - not_null
      - name: recommendation_id
        tests:
          - not_null
      - name: recommendation_type
        tests:
          - accepted_values:
              values:
                - reclaim_inactive_user
                - right_size_app
                - investigate_spend_spike
                - consolidate_apps
      - name: expected_savings
        description: "Estimated savings for the recommendation."
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [org_id, recommendation_id]
